<?xml version="1.0" encoding="iso-8859-1" standalone="no"?>
<!--
     The FreeBSD Documentation Project

     $FreeBSD$
-->

<chapter id="ppp-and-slip">
  <chapterinfo>
    <authorgroup>
      <author>
	<firstname>Jim</firstname>
	<surname>Mock</surname>
	<contrib>Restructured, reorganized, and updated by </contrib>
	<!-- 1 Mar 2000 -->
      </author>
    </authorgroup>
  </chapterinfo>

  <title><acronym>PPP</acronym> and <acronym>SLIP</acronym></title>

  <sect1 id="ppp-and-slip-synopsis">
    <title>Synopsis</title>

    <indexterm id="ppp-ppp">
      <primary>PPP</primary>
    </indexterm>

    <para>&os; has a number of ways to link one computer to another.
      To establish a network or Internet connection through a dialup
      modem, or to allow others to do so through that modem, requires
      the use of <acronym>PPP</acronym>.  This chapter details how
      to set up modem-based communication services.</para>

    <para>After reading this chapter, you will know:</para>

    <itemizedlist>
      <listitem>
	<para>How to configure <acronym>PPP</acronym>.</para>
      </listitem>
      <listitem>
	<para>How to set up <acronym>PPPoE</acronym>
	  (<acronym>PPP</acronym> over Ethernet).</para>
      </listitem>
      <listitem>
	<para>How to set up <acronym>PPPoA</acronym>
	  (<acronym>PPP</acronym> over ATM).</para>
      </listitem>
    </itemizedlist>

    <indexterm id="ppp-ppp-user">
      <primary>PPP</primary>
      <secondary>user PPP</secondary>
    </indexterm>
    <indexterm id="ppp-ppp-ethernet">
      <primary>PPP</primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <para>Before reading this chapter, you should:</para>

    <itemizedlist>
      <listitem>
	<para>Be familiar with basic network terminology.</para>
      </listitem>
      <listitem>
	<para>Understand the basics and purpose of a dialup connection
	  and <acronym>PPP</acronym>.</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="userppp">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Updated and enhanced by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Brian</firstname>
	  <surname>Somers</surname>
	  <contrib>Originally contributed by </contrib>
	</author>
      </authorgroup>
      <authorgroup>
	<author>
	  <firstname>Nik</firstname>
	  <surname>Clayton</surname>
	  <contrib>With input from </contrib>
	</author>
	<author>
	  <firstname>Dirk</firstname>
	  <surname>Fr&ouml;mberg</surname>
	</author>
	<author>
	  <firstname>Peter</firstname>
	  <surname>Childs</surname>
	</author>
      </authorgroup>
    </sect1info>

    <title>Using <acronym>PPP</acronym></title>

    <sect2>
      <title>User <acronym>PPP</acronym></title>

      <sect3>
	<title>Assumptions</title>

	<para>This document assumes you have the following:</para>

	<itemizedlist>
	  <indexterm id="ppp-isp">
	    <primary>ISP</primary>
	  </indexterm>
	  <indexterm id="ppp-ppp2">
	    <primary>PPP</primary>
	  </indexterm>
	  <listitem>
	    <para>An account with an Internet Service Provider
	    (<acronym>ISP</acronym>) for connecting using
	      <acronym>PPP</acronym>.</para>
	  </listitem>

	  <listitem>
	    <para>A modem or other device connected to the &os; system
	      and properly configured to connect to the
	      <acronym>ISP</acronym>.</para>
	  </listitem>

	  <listitem>
	    <para>The dialup number(s) of the
	      <acronym>ISP</acronym>.</para>
	  </listitem>

	  <listitem>
	    <indexterm id="ppp-pap">
	      <primary>PAP</primary>
	    </indexterm>
	    <indexterm id="ppp-chap">
	      <primary>CHAP</primary>
	    </indexterm>
	    <indexterm id="ppp-unix">
	      <primary>UNIX</primary>
	    </indexterm>
	    <indexterm id="ppp-login">
	      <primary>login name</primary>
	    </indexterm>
	    <indexterm id="ppp-password">
	      <primary>password</primary>
	    </indexterm>
	    <para>Either a
	      regular &unix; style login and password pair, or a
	      <acronym>PAP</acronym>
	      or <acronym>CHAP</acronym> login and password
	      pair.</para>
	  </listitem>

	  <listitem>
	    <indexterm id="ppp-nameserver">
	      <primary>nameserver</primary>
	    </indexterm>

	    <para>The <acronym>IP</acronym> address of one or more
	      name servers.
	      Normally, the <acronym>ISP</acronym> will provide the
	      addresses for two 
	      <acronym>DNS</acronym> servers.  If it has not,
	      include <command>enable dns</command> in
	      <filename>ppp.conf</filename> and
	      &man.ppp.8; will set the name servers.  This
	      feature requires the <acronym>ISP</acronym>'s
	      <acronym>PPP</acronym> implementation to support DNS
	      negotiation.</para>
	  </listitem>
	</itemizedlist>

	<para>The following information may be supplied by the
	  <acronym>ISP</acronym>, but is not completely
	  necessary:</para>

	<itemizedlist>
	  <listitem>
	    <para>The <acronym>IP</acronym> address of the
	      <acronym>ISP</acronym>'s
	      gateway.  The gateway is the machine to connect to
	      and will be set up as the <emphasis>default
		route</emphasis>.  When in doubt, make one up and the
	      <acronym>ISP</acronym>'s <acronym>PPP</acronym> server
	      will set the correct value during connection
	      setup.</para>

	    <para>This <acronym>IP</acronym> number is referred to as
	      <literal>HISADDR</literal> by
	      &man.ppp.8;.</para>
	  </listitem>

	  <listitem>
	    <para>The netmask.  If the <acronym>ISP</acronym> has not
	      provided one, use <hostid
		role="netmask">255.255.255.255</hostid>.</para>
	  </listitem>

	  <listitem>
	    <indexterm id="ppp-static-ip">
	      <primary>static <acronym>IP</acronym> address</primary>
	    </indexterm>

	    <para>If the <acronym>ISP</acronym> provides a static
	      <acronym>IP</acronym>
	      address and hostname, enter it.  Otherwise, let the peer
	      assign the <acronym>IP</acronym> address.</para>
	  </listitem>
	</itemizedlist>

	<para>If any of the required information is missing, contact
	  the <acronym>ISP</acronym>.</para>

	<note>
	  <para>Throughout this section, many of the examples showing
	    the contents of configuration files are numbered by line.
	    These numbers serve to aid in the presentation and
	    discussion only and are not meant to be placed in the
	    actual file.  Proper indentation with tab and space
	    characters is also important.</para>
	</note>

      </sect3>

      <sect3>
	<title>Automatic <acronym>PPP</acronym>
	  Configuration</title>

	<indexterm>
	  <primary>PPP</primary>
	  <secondary>configuration</secondary>
	</indexterm>

	<para>Several files located in <filename
	    class="directory">/etc/ppp</filename> are used to
	  configure &man.ppp.8;.
	  Examples can be found in <filename
	    class="directory">/usr/share/examples/ppp/</filename>.</para>

	<para>Configuring &man.ppp.8; requires a number of
	  files to be edited, depending on the requirements and
	  whether the <acronym>ISP</acronym> allocates
	  <acronym>IP</acronym> addresses
	  statically or dynamically.</para>

	<sect4 id="userppp-staticIP">
	  <title><acronym>PPP</acronym> and Static
	    <acronym>IP</acronym> Addresses</title>

	  <indexterm>
	    <primary>PPP</primary>
	    <secondary>with static <acronym>IP</acronym>
	      addresses</secondary>
	  </indexterm>

	  <para>Edit <filename>/etc/ppp/ppp.conf</filename> so that it
	    looks similar to the example below.</para>

	  <note>
	    <para>Lines that end in a <literal>:</literal> start in
	      the first column (beginning of the line)&mdash; all
	      other lines should be indented as shown using spaces
	      or tabs.</para>
	  </note>

	  <programlisting>1     default:
2       set log Phase Chat LCP IPCP CCP tun command
3       ident user-ppp VERSION (built COMPILATIONDATE)
4       set device /dev/cuau0
5       set speed 115200
6       set dial "ABORT BUSY ABORT NO\\sCARRIER TIMEOUT 5 \
7                 \"\" AT OK-AT-OK ATE1Q0 OK \\dATDT\\T TIMEOUT 40 CONNECT"
8       set timeout 180
9       enable dns
10
11    provider:
12      set phone "(123) 456 7890"
13      set authname foo
14      set authkey bar
15      set login "TIMEOUT 10 \"\" \"\" gin:--gin: \\U word: \\P col: ppp"
16      set timeout 300
17      set ifaddr <replaceable>x.x.x.x</replaceable> <replaceable>y.y.y.y</replaceable> 255.255.255.255 0.0.0.0
18      add default HISADDR</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 1:</term>

	      <listitem>
		<para>Identifies the default entry.  Commands in this
		  entry are executed automatically when
		  &man.ppp.8; is
		  run.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 2:</term>

	      <listitem>
		<para>Enables logging parameters.  When the
		  configuration is working satisfactorily, this line
		  should be reduced to saying:</para>

		  <programlisting>set log phase tun</programlisting>

		<para>in order to avoid excessive log file
		  sizes.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 3:</term>

	      <listitem>
		<para>Tells <acronym>PPP</acronym> how to identify
		  itself to the peer if it has any trouble negotiating
		  and setting up the link.  This information may be
		  useful to the peer's administrator when
		  investigating such problems.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 4:</term>

	      <listitem>
		<para>Identifies the device to which the modem is
		  connected.  <devicename>COM1</devicename> is
		  <filename class="devicefile">/dev/cuau0</filename>
		  and
		  <devicename>COM2</devicename> is
		  <filename
		    class="devicefile">/dev/cuau1</filename>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 5:</term>

	      <listitem>
		<para>Sets the connection speed.  If
		  <literal>115200</literal> does not work (it should
		  with any reasonably new modem), try
		  <literal>38400</literal> instead.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 6 &amp; 7:</term>

	      <listitem>
		<indexterm>
		  <primary>PPP</primary>
		  <secondary>user PPP</secondary>
		</indexterm>

		<para>The dial string.  <acronym>PPP</acronym> uses an
		  expect-send syntax similar to the one used by
		  &man.chat.8;.  Refer to &man.chat.8; for information
		  on the features of this language.</para>

		<para>Note that this command continues onto the next
		  line for readability.  Any command in
		  <filename>ppp.conf</filename> may do this if the
		  last character on the line is a <literal>\</literal>
		  character.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 8:</term>

	      <listitem>
		<para>Sets the idle timeout for the link.  180 seconds
		  is the default, so this line is purely
		  cosmetic.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 9:</term>

	      <listitem>
		<para>Tells <acronym>PPP</acronym> to ask the peer to
		  confirm the local resolver settings.  When running a
		  local name server, this line should be commented out
		  or removed.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 10:</term>

	      <listitem>
		<para>A blank line for readability.  Blank lines are
		  ignored by <acronym>PPP</acronym>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 11:</term>

	      <listitem>
		<para>Identifies an entry for a provider called
		  <quote>provider</quote>.  This could be changed
		  to the name of the <acronym>ISP</acronym> so
		  that <option>load
		    <replaceable>ISP</replaceable></option> can be
		  used to start the connection.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 12:</term>

	      <listitem>
		<para>Sets the phone number for this provider.
		  Multiple phone numbers may be specified using the
		  colon (<literal>:</literal>) or pipe character
		  (<literal>|</literal>) as a separator.  The
		  difference between the two separators is described
		  in &man.ppp.8;.  To summarize, to rotate through the
		  numbers, use a colon.  To always attempt to dial the
		  first number first and only use the other numbers if
		  the first number fails, use the pipe character.
		  Always quote the entire set of phone numbers as
		  shown.</para>

		<para>The phone number must be enclosed in quotation
		  marks (<literal>"</literal>) if there are any spaces
		  in the phone number.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 13 &amp; 14:</term>

	      <listitem>
		<para>Identifies the user name and password.  When
		  connecting using a &unix; style login prompt, these
		  values are referred to by the <command>set
		    login</command> command using the \U and \P
		  variables.  When connecting using
		  <acronym>PAP</acronym>
		  or <acronym>CHAP</acronym>, these
		  values are used at authentication time.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 15:</term>

	      <listitem>
		<indexterm><primary>PAP</primary></indexterm>
		<indexterm><primary>CHAP</primary></indexterm>
		<para>When using <acronym>PAP</acronym> or
		  <acronym>CHAP</acronym>,
		  there will be no login
		  and this line should be commented out or removed.
		  See <xref linkend="userppp-PAPnCHAP"/> for further
		  details.</para>

		<para>The login string is of the same chat-like
		  syntax as the dial string.  In this example, the
		  string works for a service whose login session looks
		  like this:</para>

		<screen>J. Random Provider
login: <replaceable>foo</replaceable>
password: <replaceable>bar</replaceable>
protocol: ppp</screen>

		<para>Replace the login and password values with
		  those required by the <acronym>ISP</acronym>.  When
		  writing this script for the first time, ensure that
		  <quote>chat</quote> logging is enabled in order to
		  determine if the conversation is going as
		  expected.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 16:</term>

	      <listitem>
		<indexterm><primary>timeout</primary></indexterm>

		<para>Sets the default idle timeout (in seconds) for
		  the connection.  Here, the connection will be closed
		  automatically after 300 seconds of inactivity.  To
		  never timeout, set this value to zero or use the
		  <option>-ddial</option> command line switch.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 17:</term>
	      <listitem>
		<indexterm><primary>ISP</primary></indexterm>

		<para>Sets the interface addresses.  The string
		  <replaceable>x.x.x.x</replaceable> should be
		  replaced by the <acronym>IP</acronym> address the
		  provider has
		  allocated.  The string
		  <replaceable>y.y.y.y</replaceable> should be
		  replaced by the <acronym>IP</acronym> address of the
		  <acronym>ISP</acronym>'s gateway.  If the ISP has
		  not provided a gateway address, use <hostid
		  role="netmask">10.0.0.2/0</hostid>.  When using a
		  <quote>guessed</quote> address, make sure to create
		  an entry in
		  <filename>/etc/ppp/ppp.linkup</filename> as per the
		  instructions in <xref linkend="userppp-dynamicIP"/>.
		  If this line is
		  omitted, &man.ppp.8; cannot run in
		  <option>-auto</option> mode.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 18:</term>

	      <listitem>
		<para>Adds a default route to the
		  <acronym>ISP</acronym>'s gateway.  The special word
		  <literal>HISADDR</literal> is replaced with the
		  gateway address specified on line 17.  It is
		  important that this line appears after line 17,
		  otherwise <literal>HISADDR</literal> will not yet
		  be initialized.</para>

		<para>When &man.ppp.8; is not run in
		  <option>-auto</option> mode, this line should be
		  moved to <filename>ppp.linkup</filename>.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>It is not necessary to add an entry to
	    <filename>ppp.linkup</filename> when using a static
	    <acronym>IP</acronym> address with &man.ppp.8; in
	    <option>-auto</option> mode as the routing table entries
	    are already correct before a connection is established. 
	    However, an entry can be created to invoke programs after
	    connection.  This is explained later with the sendmail
	    example.</para>

	  <para>Example configuration files can be found in the
	    <filename
	      class="directory">/usr/share/examples/ppp/</filename>
	    directory.</para>
	</sect4>

	<sect4 id="userppp-dynamicIP">
	  <title><acronym>PPP</acronym> and Dynamic
	    <acronym>IP</acronym> Addresses</title>

	  <indexterm>
	    <primary>PPP</primary>
	    <secondary>with dynamic <acronym>IP</acronym>
	      addresses</secondary>
	  </indexterm>

	  <indexterm>
	    <primary>IPCP</primary>
	  </indexterm>

	  <para>If the service provider does not assign static
	    <acronym>IP</acronym>
	    addresses, &man.ppp.8; can be configured to
	    negotiate the local and remote addresses.  This is done by
	    <quote>guessing</quote> an <acronym>IP</acronym> address
	    and allowing
	    &man.ppp.8; to set it up correctly using the
	    <acronym>IP</acronym>
	    Configuration Protocol (<acronym>IPCP</acronym>) after
	    connecting.  The
	    <filename>ppp.conf</filename> configuration is the same as
	    that described in <xref linkend="userppp-staticIP"/>, with
	    the following
	    change:</para>

	  <programlisting>17      set ifaddr 10.0.0.1/0 10.0.0.2/0 255.255.255.255 0.0.0.0</programlisting>

	  <para>Again, do not include the line number, it is just for
	    reference.  Indentation of at least one space is
	    required.</para>

	  <variablelist>
	    <varlistentry>
	      <term>Line 17:</term>

	      <listitem>
		<para>The number after the <literal>/</literal>
		  character is the number of bits of the address that
		  &man.ppp.8; will insist on.  These
		  <acronym>IP</acronym> numbers can be replaced, but
		  the above example
		  will always work.</para>

		<para>The last argument (<literal>0.0.0.0</literal>)
		  tells <acronym>PPP</acronym> to start negotiations
		  using address <hostid role="ipaddr">0.0.0.0</hostid>
		  rather than <hostid role="ipaddr">10.0.0.1</hostid>
		  and is necessary for some <acronym>ISP</acronym>s.
		  Do not use <literal>0.0.0.0</literal> as the first
		  argument to <command>set ifaddr</command> as it
		  prevents <acronym>PPP</acronym> from setting up an
		  initial route in <option>-auto</option> mode.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>When not running in <option>-auto</option> mode,
	    create an entry in
	    <filename>/etc/ppp/ppp.linkup</filename>.
	    <filename>ppp.linkup</filename> is used after a connection
	    has been established.  At this point,
	    &man.ppp.8; will have assigned the interface
	    addresses and it will now be possible to add the routing
	    table entries:</para>

	  <programlisting>1     provider:
2      add default HISADDR</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 1:</term>

	      <listitem>
		<para>On establishing a connection,
		  &man.ppp.8; will look for an entry in
		  <filename>ppp.linkup</filename> according to the
		  following rules. First, try to match the same label
		  used in <filename>ppp.conf</filename>.  If
		  that fails, look for an entry for the four-octet
		  <acronym>IP</acronym> address of
		  the gateway.  If an entry is still not found, look
		  for the <literal>MYADDR</literal> entry.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 2:</term>

	      <listitem>
		<para>This line tells &man.ppp.8; to add a
		  default route that points to
		  <literal>HISADDR</literal>.
		  <literal>HISADDR</literal> will be replaced with the
		  <acronym>IP</acronym> number of the gateway as
		  negotiated by
		  <acronym>IPCP</acronym>.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>

	  <para>See the <literal>pmdemand</literal> entry in the files
	    <filename>/usr/share/examples/ppp/ppp.conf.sample</filename>
	    and
	    <filename>/usr/share/examples/ppp/ppp.linkup.sample</filename>
	    for a detailed example.</para>
	</sect4>

	<sect4>
	  <title>Receiving Incoming Calls</title>

	  <indexterm>
	    <primary>PPP</primary>
	    <secondary>receiving incoming calls</secondary>
	  </indexterm>

	  <para>When configuring &man.ppp.8; to receive
	    incoming calls on a machine connected to a
	    <acronym>LAN</acronym>, decide if
	    packets should be forwarded to the local network.
	    If so, allocate
	    the peer an <acronym>IP</acronym> number from the local
	    subnet and use
	    <command>enable proxy</command> in
	    <filename>/etc/ppp/ppp.conf</filename>.  Also, confirm
	    that <filename>/etc/rc.conf</filename> contains the
	    following:</para>

	  <programlisting>gateway_enable="YES"</programlisting>
	</sect4>

	<sect4>
	  <title>Which &man.getty.8;?</title>

	  <para><xref linkend="dialup"/> provides a good description
	    on enabling dialup services using &man.getty.8;.</para>

	  <para>An alternative to &man.getty.8; is <ulink
	      url="http://mgetty.greenie.net/">mgetty</ulink>, a
	    smarter version of &man.getty.8;
	    designed with dialup lines in mind.  It can be installed
	    from the <filename
	      role="package">comms/mgetty+sendfax</filename> package
	    or port.</para>

	  <para>The advantages of using &man.getty.8; is
	    that it actively <emphasis>talks</emphasis> to modems.
	    If the port is turned off in
	    <filename>/etc/ttys</filename>, the modem will not answer
	    the phone.</para>

	  <para>The &os; version of &man.getty.8;
	    supports the automatic detection of
	    <acronym>PPP</acronym> streams, allowing clients
	    scriptless access to the server.</para>

	  <para>Refer to <xref linkend="userppp-mgetty"/>
	      for more information on
	    &man.getty.8;.</para>
	</sect4>

	<sect4>
	  <title><acronym>PPP</acronym> Permissions</title>

	  <para>Typically, &man.ppp.8; is
	    run as the <username>root</username> user.  To give a
	    user permission to run &man.ppp.8; in server
	    mode, add their user account to the
	    <groupname>network</groupname> group in
	    <filename>/etc/group</filename>.</para>

	  <para>Then, give the account access to one or more sections
	    of the configuration file using
	    <command>allow</command>, as seen in this example:</para>

	  <programlisting>allow users fred mary</programlisting>

	  <para>If this command is used in the
	    <literal>default</literal> section, it gives the specified
	    users access to everything.</para>
	</sect4>

	<sect4>
	  <title><acronym>PPP</acronym> Shells for
	    Dynamic-<acronym>IP</acronym>
	    Users</title>

	  <indexterm>
	    <primary>PPP shells</primary>
	  </indexterm>

	  <para>Create a file called
	    <filename>/etc/ppp/ppp-shell</filename> containing the
	    following:</para>

	  <programlisting>#!/bin/sh
IDENT=`echo $0 | sed -e 's/^.*-\(.*\)$/\1/'`
CALLEDAS="$IDENT"
TTY=`tty`

if [ x$IDENT = xdialup ]; then
        IDENT=`basename $TTY`
fi

echo "PPP for $CALLEDAS on $TTY"
echo "Starting PPP for $IDENT"

exec /usr/sbin/ppp -direct $IDENT</programlisting>

	  <para>This script should be executable.  Now make a
	    symbolic link called <filename>ppp-dialup</filename> to
	    this script using the following commands:</para>

	  <screen>&prompt.root; <userinput>ln -s ppp-shell /etc/ppp/ppp-dialup</userinput></screen>

	  <para>Use this script as the <emphasis>shell</emphasis> for
	    all dialup users.  This is an example from
	    <filename>/etc/passwd</filename> for a dialup
	    <acronym>PPP</acronym> user with the username
	    <username>pchilds</username>.  Do not directly edit this
	    file, use &man.vipw.8;.</para>

	    <programlisting>pchilds:*:1011:300:Peter Childs PPP:/home/ppp:/etc/ppp/ppp-dialup</programlisting>

	    <para>Create a <filename
		class="directory">/home/ppp</filename> directory that
	      is world readable containing the following 0 byte
	      files:</para>

	    <screen>-r--r--r--   1 root     wheel           0 May 27 02:23 .hushlogin
-r--r--r--   1 root     wheel           0 May 27 02:22 .rhosts</screen>

	    <para>which prevents <filename>/etc/motd</filename> from
	      being displayed.</para>
	  </sect4>

	  <sect4>
	    <title><acronym>PPP</acronym> Shells for
	      Static-<acronym>IP</acronym>
	      Users</title>

	    <indexterm>
	      <primary>PPP shells</primary>
	    </indexterm>

	    <para>Create <filename>ppp-shell</filename> as described
	      above, and for each account with a statically assigned
	      <acronym>IP</acronym>, create a symbolic link to
	      <filename>ppp-shell</filename>.</para>

	    <para>Consider three dialup customers,
	      <username>fred</username>, <username>sam</username>,
	      and <username>mary</username>.  In order to route /24
	      CIDR networks, type the following:</para>

	    <screen>&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-fred</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-sam</userinput>
&prompt.root; <userinput>ln -s /etc/ppp/ppp-shell /etc/ppp/ppp-mary</userinput></screen>

	    <para>Each of these users dialup accounts should have
	      their shell set to the symbolic link created above (for
	      example, <username>mary</username>'s shell should be
	      <filename>/etc/ppp/ppp-mary</filename>).</para>
	  </sect4>

	  <sect4>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Dynamic-<acronym>IP</acronym> Users</title>

	    <para>Here is a sample
	      <filename>/etc/ppp/ppp.conf</filename>:</para>

	    <programlisting>default:
  set debug phase lcp chat
  set timeout 0

ttyu0:
  set ifaddr 203.14.100.1 203.14.100.20 255.255.255.255
  enable proxy

ttyu1:
  set ifaddr 203.14.100.1 203.14.100.21 255.255.255.255
  enable proxy</programlisting>

	    <note>
	      <para>The indenting is important.</para>
	    </note>

	    <para>The <literal>default:</literal> section is loaded
	      for each session.  For each dialup line enabled in
	      <filename>/etc/ttys</filename> create an entry similar
	      to the one for <literal>ttyu0:</literal> above.  Each
	      line should get a unique <acronym>IP</acronym> address
	      from the pool of
	      <acronym>IP</acronym> addresses for dynamic users.</para>
	  </sect4>

	  <sect4>
	    <title>Setting Up <filename>ppp.conf</filename> for
	      Static-<acronym>IP</acronym> Users</title>

	    <para>Along with the contents of the sample
	      <filename>/usr/share/examples/ppp/ppp.conf</filename>
	      above, add a section for each of the statically assigned
	      dialup users:</para>

	    <programlisting>fred:
  set ifaddr 203.14.100.1 203.14.101.1 255.255.255.255

sam:
  set ifaddr 203.14.100.1 203.14.102.1 255.255.255.255

mary:
  set ifaddr 203.14.100.1 203.14.103.1 255.255.255.255</programlisting>

	    <para>The file <filename>/etc/ppp/ppp.linkup</filename>
	      should also contain routing information for each static
	      <acronym>IP</acronym> user if required.  The line below
	      would add a route
	      for the <hostid role="ipaddr">203.14.101.0/24</hostid>
	      network via the client's <acronym>PPP</acronym>
	      link.</para>

	    <programlisting>fred:
  add 203.14.101.0 netmask 255.255.255.0 HISADDR

sam:
  add 203.14.102.0 netmask 255.255.255.0 HISADDR

mary:
  add 203.14.103.0 netmask 255.255.255.0 HISADDR</programlisting>
	</sect4>

	<sect4 id="userppp-mgetty">
	  <title>&man.getty.8; and AutoPPP</title>

	  <indexterm>
	    <primary>&man.getty.8;</primary>
	  </indexterm>

	  <indexterm>
	    <primary>AutoPPP</primary>
	  </indexterm>

	  <indexterm>
	    <primary>LCP</primary>
	  </indexterm>

	  <para>By default the <filename
	      role="package">comms/mgetty+sendfax</filename> port
	    comes with the <literal>AUTO_PPP</literal> option enabled
	    allowing &man.getty.8; to detect the LCP
	    phase of <acronym>PPP</acronym> connections and
	    automatically spawn off a &man.ppp.8; shell.
	    However, since the default login/password sequence does
	    not occur it is necessary to authenticate users using
	    either <acronym>PAP</acronym> or
	    <acronym>CHAP</acronym>.</para>

	  <para>This section assumes the user has successfully
	    compiled, and installed the <filename
	      role="package">comms/mgetty+sendfax</filename> port on
	    his system.</para>

	  <para>Make sure
	    <filename>/usr/local/etc/mgetty+sendfax/login.config</filename>
	    has the following:</para>

	  <programlisting>/AutoPPP/ -     - /etc/ppp/ppp-pap-dialup</programlisting>

	  <para>This will tell &man.getty.8; to run the
	    <filename>ppp-pap-dialup</filename> script for detected
	    <acronym>PPP</acronym> connections.</para>

	  <para>Create a file called
	    <filename>/etc/ppp/ppp-pap-dialup</filename> containing
	    the following (the file should be executable):</para>

	  <programlisting>#!/bin/sh
exec /usr/sbin/ppp -direct pap$IDENT</programlisting>

	  <para>For each dialup line enabled in
	    <filename>/etc/ttys</filename>, create a corresponding
	    entry in <filename>/etc/ppp/ppp.conf</filename>.</para>

	  <programlisting>pap:
  enable pap
  set ifaddr 203.14.100.1 203.14.100.20-203.14.100.40
  enable proxy</programlisting>

	  <para>Each user logging in with this method will need to
	    have a username/password in
	    <filename>/etc/ppp/ppp.secret</filename>.
	    Alternatively, add the following option to authenticate
	    users via <acronym>PAP</acronym> from
	    <filename>/etc/passwd</filename>:</para>

	  <programlisting>enable passwdauth</programlisting>

	  <para>To assign some users a static <acronym>IP</acronym>,
	    specify the <acronym>IP</acronym>
	    address as the third argument in
	    <filename>/etc/ppp/ppp.secret</filename>.  See
	    <filename>/usr/share/examples/ppp/ppp.secret.sample</filename>
	    for examples.</para>
	</sect4>

	<sect4>
	  <title>MS Extensions</title>

	  <indexterm>
	    <primary>DNS</primary>
	  </indexterm>

	  <indexterm>
	    <primary>NetBIOS</primary>
	  </indexterm>

	  <indexterm>
	    <primary>PPP</primary>
	    <secondary>Microsoft extensions</secondary>
	  </indexterm>

	  <para>It is possible to configure <acronym>PPP</acronym> to
	    supply DNS and NetBIOS nameserver addresses on
	    demand.</para>

	  <para>To enable these extensions with <acronym>PPP</acronym>
	    version 1.x, the following lines might be added to the
	    relevant section of
	    <filename>/etc/ppp/ppp.conf</filename>.</para>

	  <programlisting>enable msext
set ns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para>And for <acronym>PPP</acronym> version 2 and
	    above:</para>

	  <programlisting>accept dns
set dns 203.14.100.1 203.14.100.2
set nbns 203.14.100.5</programlisting>

	  <para>This will tell the clients the primary and secondary
	    name server addresses, and a NetBIOS nameserver
	    host.</para>

	  <para>In version 2 and above, if the
	    <literal>set dns</literal> line is omitted,
	    <acronym>PPP</acronym> will use the values found in
	    <filename>/etc/resolv.conf</filename>.</para>
	</sect4>

	<sect4 id="userppp-PAPnCHAP">
	  <title><acronym>PAP</acronym> and <acronym>CHAP</acronym>
	    Authentication</title>

	  <indexterm><primary>PAP</primary></indexterm>
	  <indexterm><primary>CHAP</primary></indexterm>
	  <para>Some <acronym>ISP</acronym>s set their system up so
	    that the authentication part of the connection is done
	    using either the <acronym>PAP</acronym> or
	    <acronym>CHAP</acronym>
	    authentication mechanism.  If
	    this is the case, the <acronym>ISP</acronym> will not give
	    a <prompt>login:</prompt> during connection, but will
	    start talking <acronym>PPP</acronym>
	    immediately.</para>

	  <para>While <acronym>PAP</acronym> is less secure than
	    <acronym>CHAP</acronym>,
	    security is not
	    normally an issue as the clear text passwords are
	    transmitted down a
	    serial line only.  There is not much room for crackers
	    to <quote>eavesdrop</quote>.</para>

	  <para>Referring back to <xref
	      linkend="userppp-staticIP"/> and <xref
	      linkend="userppp-dynamicIP"/>, the following
	    alterations must be made:</para>

	  <programlisting>13      set authname <replaceable>MyUserName</replaceable>
14      set authkey <replaceable>MyPassword</replaceable>
15      set login</programlisting>

	  <variablelist>
	    <varlistentry>
	      <term>Line 13:</term>

	      <listitem>
		<para>This line specifies the
		  <acronym>PAP/CHAP</acronym> user name.
		  Insert the correct value for
		  <replaceable>MyUserName</replaceable>.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 14:</term>
	      <listitem>
		<indexterm><primary>password</primary></indexterm>

		<para>This line specifies the
		  <acronym>PAP/CHAP</acronym>
		  password.
		  Insert the correct value for
		  <replaceable>MyPassword</replaceable>.  An
		  additional line can be added, such as:</para>

		<programlisting>16      accept PAP</programlisting>

		<para>or</para>

		<programlisting>16      accept CHAP</programlisting>

		<para>to make it obvious that this is the intention,
		  but <acronym>PAP</acronym> and
		  <acronym>CHAP</acronym>
		  are both accepted
		  by
		  default.</para>
	      </listitem>
	    </varlistentry>

	    <varlistentry>
	      <term>Line 15:</term>

	      <listitem>
		<para>The <acronym>ISP</acronym> will not normally
		  require a login into the server when using
		  <acronym>PAP</acronym> or
		  <acronym>CHAP</acronym>.  Therefore, disable the
		  <quote>set
		    login</quote> string.</para>
	      </listitem>
	    </varlistentry>
	  </variablelist>
	</sect4>

	<sect4>
	  <title>Changing the &man.ppp.8; Configuration
	    on the Fly</title>

	  <para>It is possible to talk to &man.ppp.8;
	    while it is running in the background, but only
	    if a suitable diagnostic port has been set up.  To do
	    this, add the following line to the configuration:</para>

	  <programlisting>set server /var/run/ppp-tun<replaceable>%d</replaceable> DiagnosticPassword 0177</programlisting>

	  <para>This will tell <acronym>PPP</acronym> to listen to the
	    specified &unix; domain socket, asking clients for the
	    specified password before allowing access.  The
	    <literal>%d</literal> in the name is replaced with the
	    <devicename>tun</devicename> device number that is in
	    use.</para>

	  <para>Once a socket has been set up, the &man.pppctl.8;
	    program may be used in scripts that wish to manipulate
	    the running program.</para>
	</sect4>
      </sect3>

      <sect3 id="userppp-nat">
	<title>Using <acronym>PPP</acronym> Network Address
	  Translation Capability</title>

	<indexterm>
	  <primary>PPP</primary><secondary>NAT</secondary>
	</indexterm>

	<para><acronym>PPP</acronym> has the ability to use internal
	  NAT without kernel diverting capabilities.  This
	  functionality may be enabled by the following line in
	  <filename>/etc/ppp/ppp.conf</filename>:</para>

	<programlisting>nat enable yes</programlisting>

	<para>Alternatively, <acronym>PPP</acronym> NAT may be enabled
	  by command-line option <literal>-nat</literal>. There is
	  also <filename>/etc/rc.conf</filename> knob named
	  <literal>ppp_nat</literal>, which is enabled by
	  default.</para>

	<para>When using this feature, the following
	  <filename>/etc/ppp/ppp.conf</filename> options are useful
	  to enable incoming connections forwarding:</para>

	<programlisting>nat port tcp 10.0.0.2:ftp ftp
nat port tcp 10.0.0.2:http http</programlisting>

	<para>or do not trust the outside at all</para>

	<programlisting>nat deny_incoming yes</programlisting>
      </sect3>

      <sect3 id="userppp-final">
	<title>Final System Configuration</title>

	<indexterm>
	  <primary>PPP</primary><secondary>configuration</secondary>
	</indexterm>

	<para>Now that &man.ppp.8; is configured, there are
	  a few more things to edit in
	  <filename>/etc/rc.conf</filename>.</para>

	<para>Working from the top down in this file, make sure the
	  <literal>hostname=</literal> line is set, e.g.:</para>

	<programlisting>hostname="foo.example.com"</programlisting>

	<para>If the <acronym>ISP</acronym> has supplied a static
	  <acronym>IP</acronym>
	  address and name, it is recommended to use this name as the
	  host name.</para>

	<para>Look for the <literal>network_interfaces</literal>
	  variable.  To configure the system to dial the
	  <acronym>ISP</acronym> on demand, make sure the
	  <devicename>tun0</devicename> device is added to the list,
	  otherwise remove it.</para>

	<programlisting>network_interfaces="lo0 tun0"
ifconfig_tun0=</programlisting>

	<note>
	  <para>The <literal>ifconfig_tun0</literal> variable should
	    be empty, and a file called
	    <filename>/etc/start_if.tun0</filename> should be created.
	    This file should contain the line:</para>

	  <programlisting>ppp -auto mysystem</programlisting>

	  <para>This script is executed at network configuration time,
	    starting the &man.ppp.8; daemon in
	    <option>-auto</option> mode.  If the machine functions as
	    a gateway for a <acronym>LAN</acronym>, consider using the
	    <option>-alias</option> switch.  Refer to the manual page
	    for details.</para>
	</note>

	<para>Make sure that the router program is set to
	  <literal>NO</literal> with the following line in
	  <filename>/etc/rc.conf</filename>:</para>

	<programlisting>router_enable="NO"</programlisting>

	<indexterm>
	  <primary><application>routed</application></primary>
	</indexterm>

	<para>It is important that the &man.routed.8;
	  daemon is not started, as &man.routed.8; tends
	  to delete the default routing table entries created by
	  &man.ppp.8;.</para>

	<para>It is probably a good idea to ensure that the
	  <literal>sendmail_flags</literal> line does not include
	  <option>-q</option>; otherwise,
	  &man.sendmail.8; will attempt to do a network
	  lookup every now and then, possibly causing the machine
	  to dial out.  Try this command instead:</para>

	<programlisting>sendmail_flags="-bd"</programlisting>

	<indexterm>
	  <primary><application>Sendmail</application></primary>
	</indexterm>
	<para>The downside is that &man.sendmail.8; must be
	  forced to re-examine the mail queue whenever the
	  <acronym>PPP</acronym> link is up by typing:</para>

	<screen>&prompt.root; <userinput>/usr/sbin/sendmail -q</userinput></screen>

	<para>To automatically use <command>!bg</command>
	  in <filename>ppp.linkup</filename>:</para>

	<programlisting>1     provider:
2       delete ALL
3       add 0 0 HISADDR
4       !bg sendmail -bd -q30m</programlisting>

	<indexterm>
	  <primary>SMTP</primary>
	</indexterm>

	<para>It is possible to set up a <quote>dfilter</quote> to
	  block SMTP traffic.  Refer to the sample files for further
	  details.</para>

	<para>All that is left is to reboot the machine.  After
	  rebooting, either type:</para>

	<screen>&prompt.root; <userinput>ppp</userinput></screen>

	<para>and then <command>dial provider</command> to start the
	  <acronym>PPP</acronym> session, or, to configure
	  &man.ppp.8; to establish sessions automatically
	  when there is outbound traffic and there is no existing
	  <filename>start_if.tun0</filename> script, type:</para>

	<screen>&prompt.root; <userinput>ppp -auto provider</userinput></screen>
      </sect3>

      <sect3>
	<title>Summary</title>

	<para>To recap, the following steps are necessary when setting
	  up <acronym>PPP</acronym> for the first time:</para>

	<para>Client side:</para>

	<procedure>
	  <step>
	    <para>Ensure that the <devicename>tun</devicename> device
	      is built into the kernel.</para>
	  </step>

	  <step>
	    <para>Ensure that the <filename
		class="devicefile">tun<replaceable>N</replaceable></filename>
	      device file is available in the <filename
		class="directory">/dev</filename> directory.</para>
	  </step>

	  <step>
	    <para>Create an entry in
	      <filename>/etc/ppp/ppp.conf</filename>.  The
	      <filename>pmdemand</filename> example should suffice
	      for most <acronym>ISP</acronym>s.</para>
	  </step>

	  <step>
	    <para>When using a dynamic <acronym>IP</acronym> address,
	      create an entry in
	      <filename>/etc/ppp/ppp.linkup</filename>.</para>
	  </step>

	  <step>
	    <para>Update <filename>/etc/rc.conf</filename>.</para>
	  </step>

	  <step>
	    <para>Create a <filename>start_if.tun0</filename> script
	      if demand dialing is required.</para>
	  </step>
	</procedure>

	<para>Server side:</para>

	<procedure>
	  <step>
	    <para>Ensure that the <devicename>tun</devicename> device
	      is built into the kernel.</para>
	  </step>

	  <step>
	    <para>Ensure that the
	      <filename
		class="devicefile">tun<replaceable>N</replaceable></filename>
	      device file is available in the <filename
		class="directory">/dev</filename> directory.</para>
	  </step>

	  <step>
	    <para>Create an entry in <filename>/etc/passwd</filename>
	      (using the &man.vipw.8; program).</para>
	  </step>

	  <step>
	    <para>Create a profile in this user's home directory that
	      runs <command>ppp -direct
		direct-server</command>.</para>
	  </step>

	  <step>
	    <para>Create an entry in
	      <filename>/etc/ppp/ppp.conf</filename>.  The
	      <filename>direct-server</filename> example should
	      suffice.</para>
	  </step>

	  <step>
	    <para>Create an entry in
	      <filename>/etc/ppp/ppp.linkup</filename>.</para>
	  </step>

	  <step>
	    <para>Update <filename>/etc/rc.conf</filename>.</para>
	  </step>
	</procedure>
      </sect3>
    </sect2>
  </sect1>

  <sect1 id="ppp-troubleshoot">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Tom</firstname>
	  <surname>Rhodes</surname>
	  <contrib>Contributed by </contrib>
	</author>
      </authorgroup>
      <!-- 13 June 2003 -->
    </sect1info>
    <title>Troubleshooting <acronym>PPP</acronym> Connections</title>

    <indexterm>
      <primary>PPP</primary>
      <secondary>troubleshooting</secondary>
    </indexterm>

    <para>This section covers a few issues which may arise when
      using <acronym>PPP</acronym> over a modem connection.  Some
      <acronym>ISP</acronym>s present the
      <literal>ssword</literal> prompt, and others will present
      <literal>password</literal>; if the &man.ppp.8;
      script is not written accordingly, the login attempt will
      fail.  The most common way to debug &man.ppp.8;
      connections is by connecting manually.  The following
      information walks through a manual connection step by
      step.</para>

    <sect2>
      <title>Check the Device Nodes</title>

      <para>When using a custom kernel, make sure to include the
	following line in the kernel configuration file:</para>

      <programlisting>device   uart</programlisting>

      <para>The <devicename>uart</devicename> device is already
	included in the <literal>GENERIC</literal> kernel, so no
	additional steps are necessary in this case.  Just
	check the &man.dmesg.8; output for the modem
	device with:</para>

      <screen>&prompt.root; <userinput>dmesg | grep uart</userinput></screen>

      <para>The <devicename>uart</devicename> devices should provide
	some pertinent output about the COM ports.  If the modem acts
	like a standard serial port, it should be listed on
	<devicename>uart1</devicename>, or
	<devicename>COM2</devicename>.  If so, a custom kernel is not
	needed.  In this configuration, the modem device would be
	<filename class="devicefile">/dev/cuau1</filename>.</para>
    </sect2>

    <sect2>
      <title>Connecting Manually</title>

      <para>Connecting to the Internet by manually controlling
	&man.ppp.8; is quick, easy, and a great way to
	debug a connection or just get information on how the
	<acronym>ISP</acronym> treats &man.ppp.8; client
	connections.  The following examples use
	<emphasis>example</emphasis> as the hostname of the
	machine running &man.ppp.8;.  To start
	&man.ppp.8;:</para>

      <screen>&prompt.root; <userinput>ppp</userinput></screen>

      <para>This sets the modem device to
	<devicename>cuau1</devicename>:</para>
	
      <screen>ppp ON example&gt; <userinput>set device <filename class="devicefile">/dev/cuau1</filename></userinput></screen>

      <para>This sets the connection speed to 115,200
	<acronym>kbps</acronym>:</para>

      <screen>ppp ON example&gt; <userinput>set speed 115200</userinput></screen>

      <para>This tells &man.ppp.8; to configure the
	resolver and add the nameserver lines to
	<filename>/etc/resolv.conf</filename>.  If
	&man.ppp.8; cannot determine the hostname, it can
	manually be set later.</para>

      <screen>ppp ON example&gt; <userinput>enable dns</userinput></screen>

      <para>Switch to <quote>terminal</quote> mode to
	manually control the modem.</para>

      <screen>ppp ON example&gt; <userinput>term</userinput></screen>

      <programlisting>deflink: Entering terminal mode on <filename class="devicefile">/dev/cuau1</filename>
type '~h' for help</programlisting>

      <screen><userinput>at</userinput>
OK
<userinput>atdt<replaceable>123456789</replaceable></userinput></screen>

      <para>Use &man.at.1; to initialize the modem,
	then type <command>atdt</command> and the number for the
	<acronym>ISP</acronym> to begin the dial in process.</para>

      <screen>CONNECT</screen>

      <para>This message confirms the connection.  If there are
	any connection problems, unrelated to hardware, this is the
	time to
	attempt to resolve them.</para>

      <screen>ISP Login:<userinput>myusername</userinput></screen>

      <para>When prompted for a username, return the prompt with the
	username that was provided by the
	<acronym>ISP</acronym>.</para>

      <screen>ISP Pass:<userinput>mypassword</userinput></screen>

      <para>At this password prompt,
	enter the password that was provided by the
	<acronym>ISP</acronym>.  Just like logging into
	&os;, the password will not echo.</para>

      <screen>Shell or PPP:<userinput>ppp</userinput></screen>

      <para>Depending on the <acronym>ISP</acronym>, this prompt
	may never appear.  If it does, it provides a choice to
	use a shell on the provider or to start
	&man.ppp.8;.  This example chooses
	to use &man.ppp.8; in order to create an Internet
	connection.</para>

      <screen>Ppp ON example&gt;</screen>

      <para>In this example, the first <option>p</option>
	has been capitalized.  This indicates a successful
	connection to the <acronym>ISP</acronym>.</para>

      <screen>PPp ON example&gt;</screen>

      <para>This indicates successful authentication with the
	<acronym>ISP</acronym> but the
	<acronym>IP</acronym> address has not been assigned
	yet.</para>

      <screen>PPP ON example&gt;</screen>

      <para>This indicates an <acronym>IP</acronym>
	address has been assigned and the
	connection has successfully completed.</para>

      <screen>PPP ON example&gt;<userinput>add default HISADDR</userinput></screen>

      <para>This adds a default route which is needed for successful
	communication.  Until this is added, the only
	established connection is with the peer.  If this fails due to
	existing routes, put a bang character
	(<literal>!</literal>) in front of the <option>add</option>.
	Alternatively, set this before making the actual connection
	and it will negotiate a new route accordingly.</para>

      <para>If everything went well, there is now an active
	connection to the Internet which can be placed into the
	background using <keycombo
	action="simul"><keycap>CTRL</keycap>
	<keycap>z</keycap></keycombo>.  If
	<literal>PPP</literal> instead returns to
	<literal>ppp</literal>, the connection has been lost.  An
	uppercase <literal>P</literal> indicates a
	connection to the <acronym>ISP</acronym> and a lowercase
	<literal>p</literal> indicates that the connection has been
	lost.  &man.ppp.8; only has these 2 states.</para>

      <sect3>
	<title>Debugging</title>

	<para>For a direct line that cannot seem to make a connection,
	  turn hardware flow <acronym>CTS/RTS</acronym> to off with
	  <option>set ctsrts off</option>.  This can occur when
	  connected to some <acronym>PPP</acronym> capable
	  terminal servers as &man.ppp.8; hangs
	  when it tries to write data to the communication link and
	  then waits for a Clear To Send (<acronym>CTS</acronym>)
	  signal which may never come.  When using this option,
	  include <option>set accmap</option>, which may be required
	  to defeat hardware which is dependent on passing certain
	  characters from end to end, such as XON/XOFF.  See
	  &man.ppp.8; for more information on how this option is
	  used.</para>

	<para>For an older modem, <option>set parity even</option> may
	  be needed.  Parity is set at <literal>none</literal> by
	  default, but is used for error checking (with a large
	  increase in traffic) on older modems and some
	  <acronym>ISP</acronym>s.  This option may be needed for
	  the Compuserve <acronym>ISP</acronym>.</para>

	<para>&man.ppp.8; may not return to the
	  command mode, which is usually a negotiation error where
	  the <acronym>ISP</acronym> is waiting for your side to start
	  negotiating.  At this point, using <command>~p</command>
	  will force &man.ppp.8; to start
	  sending the configuration information.</para>

	<para>If a login prompt never appears, try using
	  <acronym>PAP</acronym> or <acronym>CHAP</acronym>
	  authentication instead of the &unix; style in the example
	  above.  To use <acronym>PAP</acronym> or
	  <acronym>CHAP</acronym>, add the following options to
	  &man.ppp.8; before going into terminal
	  mode:</para>

	<screen>ppp ON example&gt; <userinput>set authname <replaceable>myusername</replaceable></userinput></screen>

	<para>Where <replaceable>myusername</replaceable> should be
	  replaced with the username that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<screen>ppp ON example&gt; <userinput>set authkey <replaceable>mypassword</replaceable></userinput></screen>

	<para>Where <replaceable>mypassword</replaceable> should be
	  replaced with the password that was assigned by the
	  <acronym>ISP</acronym>.</para>

	<para>If the connection is active but cannot resolve any
	  domain names, try to &man.ping.8; an <acronym>IP</acronym>
	  address.  If there is 100% packet loss, it is likely that a
	  default route was not assigned.  Double check that
	  <option>add default HISADDR</option> was set during the
	  connection.  If a connection to a remote
	  <acronym>IP</acronym> address cannot be established, it is
	  possible that a resolver address has not been added to
	  <filename>/etc/resolv.conf</filename>.  This file should
	  look like:</para>

	<programlisting>domain <replaceable>example.com</replaceable>
nameserver <replaceable>x.x.x.x</replaceable>
nameserver <replaceable>y.y.y.y</replaceable></programlisting>

	<para>Where <replaceable>x.x.x.x</replaceable> and
	  <replaceable>y.y.y.y</replaceable> should be replaced with
	  the <acronym>IP</acronym> address of the
	  <acronym>ISP</acronym>'s DNS servers.</para>

	<para>To configure &man.syslog.3; to log
	  &man.ppp.8; connections, add:</para>

	<programlisting>!ppp
*.*     /var/log/ppp.log</programlisting>

	<para>to <filename>/etc/syslog.conf</filename>.  In most
	  cases, this functionality already exists.</para>

      </sect3>
    </sect2>
  </sect1>




  <sect1 id="pppoe">
    <sect1info>
      <authorgroup>
	<author>
	  <firstname>Jim</firstname>
	  <surname>Mock</surname>
	  <contrib>Contributed (from
	    http://node.to/freebsd/how-tos/how-to-freebsd-pppoe.html)
	    by </contrib>
	</author>
      </authorgroup>
      <!-- 10 Jan 2000 -->
    </sect1info>

    <title>Using <acronym>PPP</acronym> over Ethernet
      (<acronym>PPPoE</acronym>)</title>

    <indexterm>
      <primary>PPP</primary>
      <secondary>over Ethernet</secondary>
    </indexterm>

    <indexterm>
      <primary>PPPoE</primary>
      <see>PPP, over Ethernet</see>
    </indexterm>

    <para>This section describes how to set up <acronym>PPP</acronym>
      over Ethernet (<acronym>PPPoE</acronym>).</para>

    <sect2>
      <title>Configuring the Kernel</title>

      <para>No kernel configuration is necessary for
	<acronym>PPPoE</acronym>.  If the necessary netgraph support
	is not built into the kernel, it will be dynamically loaded by
	&man.ppp.8;.</para>
    </sect2>

    <sect2>
      <title>Setting Up <filename>ppp.conf</filename></title>

      <para>Here is an example of a working
	<filename>ppp.conf</filename>:</para>

      <programlisting>default:
  set log Phase tun command # you can add more detailed logging if you wish
  set ifaddr 10.0.0.1/0 10.0.0.2/0

name_of_service_provider:
  set device PPPoE:<replaceable>xl1</replaceable> # replace xl1 with your Ethernet device
  set authname YOURLOGINNAME
  set authkey YOURPASSWORD
  set dial
  set login
  add default HISADDR</programlisting>

    </sect2>

    <sect2>
      <title>Running &man.ppp.8;</title>

      <para>As <username>root</username>, run:</para>

      <screen>&prompt.root; <userinput>ppp -ddial name_of_service_provider</userinput></screen>

    </sect2>

    <sect2>
      <title>Starting &man.ppp.8; at Boot</title>

      <para>Add the following to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_nat="YES"	# if you want to enable nat for your local network, otherwise NO
ppp_profile="name_of_service_provider"</programlisting>
    </sect2>

    <sect2>
      <title>Using a <acronym>PPPoE</acronym> Service Tag</title>

      <para>Sometimes it will be necessary to use a service tag to
	establish the connection.  Service tags are used to
	distinguish between different <acronym>PPPoE</acronym> servers
	attached to a given network.</para>

      <para>If the service tag is not in the documentation provided
	by the <acronym>ISP</acronym>, ask the
	<acronym>ISP</acronym>'s tech support personnel.</para>

      <para>As a last resort, try using <filename
	  role="package">net/rp-pppoe</filename>.  This application
	may de-program the modem and render it useless, so think
	twice before using it.  Install the program shipped with the
	modem by the provider, then access the
	<guimenu>System</guimenu> menu from the program.  The name of
	the profile should be listed there.  It is usually
	<emphasis>ISP</emphasis>.</para>

      <para>The profile name (service tag) will be used in the
	<acronym>PPPoE</acronym> configuration entry in
	<filename>ppp.conf</filename> as the provider part of
	<command>set device</command>, as described in &man.ppp.8;.
	It should look like
	this:</para>

      <programlisting>set device PPPoE:<replaceable>xl1</replaceable>:<replaceable>ISP</replaceable></programlisting>

      <para>Do not forget to change <replaceable>xl1</replaceable>
	to the proper device for the Ethernet card.</para>
      <para>Do not forget to change <replaceable>ISP</replaceable>
	to the profile found above.</para>

      <para>For additional information, see <ulink
	      url="http://renaud.waldura.com/doc/freebsd/pppoe/">Cheaper
	      Broadband with &os; on
	      <acronym>DSL</acronym></ulink>.</para>
    </sect2>

    <sect2 id="ppp-3com">

      <title><acronym>PPPoE</acronym> with a &tm.3com;
	<trademark class="registered">HomeConnect</trademark>
	<acronym>ADSL</acronym>
	Modem Dual Link</title>

      <para>This modem does not follow <ulink
	  url="http://www.faqs.org/rfcs/rfc2516.html">RFC
	  2516</ulink>.
	Instead, different packet type codes have been
	used for the Ethernet frames.  Please complain to <ulink
	  url="http://www.3com.com/">3Com</ulink> if you think it
	should comply with the <acronym>PPPoE</acronym>
	specification.</para>

      <para>In order to make &os; capable of communicating with
	this device, a sysctl must be set.  This can be done
	automatically at boot time by updating
	<filename>/etc/sysctl.conf</filename>:</para>

	<programlisting>net.graph.nonstandard_pppoe=1</programlisting>

      <para>or can be done immediately with the command:</para>

      <screen>&prompt.root; <userinput>sysctl net.graph.nonstandard_pppoe=1</userinput></screen>

      <para>Unfortunately, because this is a system-wide setting,
	it is not possible to talk to a normal
	<acronym>PPPoE</acronym> client or server and a &tm.3com;
	<trademark class="registered">HomeConnect</trademark>
	<acronym>ADSL</acronym>
	modem at the same time.</para>

    </sect2>
  </sect1>

  <sect1 id="pppoa">
    <title>Using <application>PPP</application> over ATM
      (<acronym>PPPoA</acronym>)</title>

    <indexterm>
      <primary>PPP</primary>
      <secondary>over ATM</secondary>
    </indexterm>

    <indexterm>
      <primary>PPPoA</primary>
      <see>PPP, over ATM</see>
    </indexterm>

    <para>The following describes how to set up <acronym>PPP</acronym>
      over ATM (<acronym>PPPoA</acronym>).  <acronym>PPPoA</acronym>
      is a popular choice among European <acronym>DSL</acronym>
      providers.</para>

    <sect2>
      <title>Using <acronym>PPPoA</acronym> with the Alcatel
	&speedtouch; USB</title>

      <para>Like many USB devices, the Alcatel &speedtouch; USB needs
	to download firmware from the host computer to operate
	properly.  It is possible to automate this process in &os;
	so that this transfer takes place whenever the device is
	plugged into a USB port.  The following information can be
	added to <filename>/etc/usbd.conf</filename> to
	enable this automatic firmware transfer.  This file must be
	edited as the <username>root</username> user.</para>

      <programlisting>device "Alcatel SpeedTouch USB"
    devname "ugen[0-9]+"
    vendor 0x06b9
    product 0x4061
    attach "/usr/local/sbin/modem_run -f /usr/local/libdata/mgmt.o"</programlisting>

      <para>To enable the USB daemon, <application>usbd</application>,
	put the following the line into
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>usbd_enable="YES"</programlisting>

      <para>It is also possible to set up
	&man.ppp.8; to dial up at startup.  To do
	this add the following lines to
	<filename>/etc/rc.conf</filename>:</para>

      <programlisting>ppp_enable="YES"
ppp_mode="ddial"
ppp_profile="adsl"</programlisting>

      <para>For this to work correctly, use the sample
	<filename>ppp.conf</filename> supplied with the <filename
	  role="package">net/pppoa</filename> port.</para>

    </sect2>

    <sect2>
      <title>Using <application>mpd</application></title>

      <para><application>mpd</application> can be used to connect to a
	variety of services, in particular <acronym>passwd</acronym>
	services.
	<application>mpd</application> can be installed from the
	<filename role="package">net/mpd5</filename> package or port.
	Many
	<acronym>ADSL</acronym> modems require a
	<acronym>PPTP</acronym> tunnel between the
	modem and computer.  One such modem is the Alcatel
	&speedtouch;
	Home.</para>

      <para>The installation of the port places a set of well
	commented, sample
	configuration files in <filename
	  class="directory">/usr/local/etc/mpd5/</filename>.  Copy
	<filename>mpd.conf.sample</filename>, removing the
	<literal>.sample</literal> extension, and edit it to suit the
	requirements and provider settings.  A complete configuration
	guide in HTML format is installed to <filename
	  class="directory">/usr/local/share/doc/mpd5/</filename>.</para>

    <para>After saving the edits,
      initialize the connection as
      <username>root</username>:</para>

    <screen>&prompt.root; <userinput>service mpd5 start</userinput></screen>

    <para>To see the status of the connection, use:</para>

    <screen>&prompt.user; <userinput>ifconfig <replaceable>ng0</replaceable></userinput>
ng0: flags=88d1&lt;UP,POINTOPOINT,RUNNING,NOARP,SIMPLEX,MULTICAST&gt; mtu 1500
     inet 216.136.204.117 --> 204.152.186.171 netmask 0xffffffff</screen>

    <para>Using <application>mpd</application> is the recommended
      way to connect to an <acronym>ADSL</acronym> service with
      &os;.</para>

  </sect2>

  <sect2>
    <title>Using <application>pptpclient</application></title>

    <para>It is also possible to use &os; to connect to other
      <acronym>PPPoA</acronym> services using <filename
	role="package">net/pptpclient</filename>.</para>

    <para>To use <filename role="package">net/pptpclient</filename>
      to connect to a <acronym>DSL</acronym> service, install the port
      or package and
      edit <filename>/etc/ppp/ppp.conf</filename> as
      <username>root</username>.  An example section of
      <filename>ppp.conf</filename> is given below.  For further
      information on the available <filename>ppp.conf</filename>
      options, consult &man.ppp.8;.</para>

    <programlisting>adsl:
 set log phase chat lcp ipcp ccp tun command
 set timeout 0
 enable dns
 set authname <replaceable>username</replaceable> <co id="co-pptp-ex-user"/>
 set authkey <replaceable>password</replaceable> <co id="co-pptp-ex-pass"/>
 set ifaddr 0 0
 add default HISADDR</programlisting>

    <calloutlist>
      <callout arearefs="co-pptp-ex-user">
	<para>The username of the account with the
	  <acronym>DSL</acronym>
	  provider.</para>
      </callout>

      <callout arearefs="co-pptp-ex-pass">
	<para>The password for the account.</para>
      </callout>
    </calloutlist>

    <warning>
      <para>Since the account password in
	<filename>ppp.conf</filename> is in plain text format, ensure
	that this file is only readable by <username>root</username>.
	Refer to &man.chmod.1; and &man.chown.8; for further
	information.</para>

      <screen>&prompt.root; <userinput>chown root:wheel /etc/ppp/ppp.conf</userinput>
&prompt.root; <userinput>chmod 600 /etc/ppp/ppp.conf</userinput></screen>

      </warning>

      <para>This will open a tunnel for a <acronym>PPP</acronym>
	session to the <acronym>DSL</acronym> router.  Ethernet
	<acronym>DSL</acronym> modems have a
	preconfigured <acronym>LAN</acronym> <acronym>IP</acronym>
	address to connect to.
	In the case of
	the Alcatel &speedtouch; Home, this address is <hostid
	  role="ipaddr">10.0.0.138</hostid>.  The router
	documentation should indicate which address the device
	uses.  To open the tunnel and start a <acronym>PPP</acronym>
	session execute the following command:</para>

      <screen>&prompt.root; <userinput>pptp <replaceable>address</replaceable> <replaceable>adsl</replaceable></userinput></screen>

      <tip>
	<para>It is recommended to add an ampersand
	  (<quote>&amp;</quote>) to the end of the previous command
	  so that <application>pptp</application> will return the
	  prompt after starting.</para>
      </tip>

      <para>A <devicename>tun</devicename> virtual tunnel device
	will be created for interaction between the
	<application>pptp</application> and
	&man.ppp.8; processes.  Once the prompt is
	returned, or the <application>pptp</application> process has
	confirmed a connection, examine the tunnel:</para>

      <screen>&prompt.user; <userinput>ifconfig <replaceable>tun0</replaceable></userinput>
tun0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; mtu 1500
        inet 216.136.204.21 --> 204.152.186.171 netmask 0xffffff00
	Opened by PID 918</screen>

      <para>If unable to connect, check the router configuration,
	which is usually accessible via
	&man.telnet.1; or a web browser.  Examine
	the output of <command>pptp</command> and the contents of
	<filename>/var/log/ppp.log</filename> for clues.</para>
    </sect2>
  </sect1>
</chapter>
